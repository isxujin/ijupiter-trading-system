<!DOCTYPE html>
<html lang="zh-CN" 
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.w3.org/1999/xhtml"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/layout}">
<head>
    <title>新增系统参数 - iJupiter Trading System</title>
</head>
<body>
<div layout:fragment="content">
                    <div class="container-fluid">
		<h1 class="h3 mb-4">新增系统参数</h1>
		<div class="card">
			<div class="card-body">
				<form id="parameterForm">
					<div class="row">
						<div class="col-md-6">
							<div class="mb-3">
								<label for="paramCode" class="form-label required">参数编码</label>
								<input type="text" class="form-control" id="paramCode" name="paramCode" required>
							</div>
							<div class="mb-3">
								<label for="paramName" class="form-label required">参数名称</label>
								<input type="text" class="form-control" id="paramName" name="paramName" required>
							</div>
							<div class="mb-3">
								<label for="paramType" class="form-label required">参数类型</label>
								<select class="form-select" id="paramType" name="paramType">
									<option value="STRING">STRING</option>
									<option value="NUMBER">NUMBER</option>
									<option value="BOOLEAN">BOOLEAN</option>
									<option value="JSON">JSON</option>
								</select>
							</div>
							<div class="mb-3">
								<label for="paramValue" class="form-label">参数值</label>
								<textarea class="form-control" id="paramValue" name="paramValue" rows="3"></textarea>
								<div class="form-text">参数的具体值</div>
							</div>
						</div>
						<div class="col-md-6">
							<div class="mb-3">
								<label for="defaultValue" class="form-label">默认值</label>
								<textarea class="form-control" id="defaultValue" name="defaultValue" rows="3"></textarea>
								<div class="form-text">参数的默认值，用于重置时使用</div>
							</div>
							<div class="mb-3">
								<label for="validationRule" class="form-label">验证规则</label>
								<input type="text" class="form-control" id="validationRule" name="validationRule">
								<div class="form-text">正则表达式，用于验证参数值，如：^\\d+$（只允许数字）</div>
							</div>
							<div class="mb-3">
								<label for="options" class="form-label">参数选项</label>
								<textarea class="form-control" id="options" name="options" rows="4"></textarea>
								<div class="form-text">用于下拉选择的选项，JSON格式，如：[{'value':'1','label':'选项1'}]</div>
							</div>
							<div class="row">
								<div class="col-md-4">
									<div class="mb-3">
										<label for="isSystem" class="form-label">系统参数</label>
										<select class="form-select" id="isSystem" name="isSystem">
											<option value="0">否</option>
											<option value="1">是</option>
										</select>
									</div>
								</div>
								<div class="col-md-4">
									<div class="mb-3">
										<label for="isEditable" class="form-label">是否可编辑</label>
										<select class="form-select" id="isEditable" name="isEditable">
											<option value="1">是</option>
											<option value="0">否</option>
										</select>
									</div>
								</div>
								<div class="col-md-4">
									<div class="mb-3">
										<label for="sortOrder" class="form-label">排序号</label>
										<input type="number" class="form-control" id="sortOrder" name="sortOrder" value="0">
									</div>
								</div>
							</div>
						</div>
					</div>

					<div class="mb-3">
						<label for="description" class="form-label">参数描述</label>
						<textarea class="form-control" id="description" name="description" rows="3"></textarea>
						<div class="form-text">参数的功能说明</div>
					</div>

					<div class="d-flex justify-content-end">
						<button type="button" class="btn btn-outline-secondary me-2" id="cancelBtn">
							<i class="fas fa-times me-1"></i>取消
						</button>
						<button type="button" class="btn btn-outline-primary me-2" id="validateBtn">
							<i class="fas fa-check me-1"></i>验证编码
						</button>
						<button type="button" class="btn btn-primary" id="saveBtn">
							<i class="fas fa-save me-1"></i>保存
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</th:block>

<th:block layout:fragment="js">
	<script src="/js/system-ui.js"></script>
	<script src="/js/system-management.js"></script>
	<script>
	(function(){
		function showMessage(message, type){ if(window.showToast){ window.showToast(type==='error'?'error':'success', message);} else console.log(message); }

		async function validateParamCode(){
			const paramCode = document.getElementById('paramCode').value.trim();
			if(!paramCode){ showMessage('请输入参数编码','error'); return false; }
			try{
				const resp = await fetch(`/system/parameter/check/paramcode?paramCode=${encodeURIComponent(paramCode)}`);
				const res = await resp.json();
				if(res.code===200 && res.data){
					showMessage('参数编码已存在','error');
					document.getElementById('paramCode').classList.add('is-invalid');
					return false;
				}
				document.getElementById('paramCode').classList.remove('is-invalid');
				return true;
			} catch(e){ console.error(e); showMessage('验证失败','error'); return false; }
		}

		function validateForm(){
			let ok = true;
			['paramCode','paramName','paramType'].forEach(id=>{ const el=document.getElementById(id); if(!el || !el.value.trim()){ if(el) el.classList.add('is-invalid'); ok=false; } else { if(el) el.classList.remove('is-invalid'); } });
			return ok;
		}

		document.getElementById('validateBtn').addEventListener('click', function(){ validateParamCode(); });
		document.getElementById('cancelBtn').addEventListener('click', function(){ if(confirm('确定要取消吗？未保存的数据将丢失。')) window.location.href='/system/parameter/list'; });

		document.getElementById('saveBtn').addEventListener('click', async function(){
			if(!validateForm()) return;
			if(!await validateParamCode()) return;
			const payload = {
				paramCode: document.getElementById('paramCode').value.trim(),
				paramName: document.getElementById('paramName').value.trim(),
				paramValue: document.getElementById('paramValue').value.trim(),
				paramType: document.getElementById('paramType').value,
				paramGroup: document.getElementById('paramGroup') ? document.getElementById('paramGroup').value.trim() : '',
				defaultValue: document.getElementById('defaultValue').value.trim(),
				validationRule: document.getElementById('validationRule').value.trim(),
				options: document.getElementById('options').value.trim(),
				description: document.getElementById('description').value.trim(),
				isSystem: parseInt(document.getElementById('isSystem').value||0),
				isEditable: parseInt(document.getElementById('isEditable').value||1),
				sortOrder: parseInt(document.getElementById('sortOrder').value) || 0
			};
			if(window.submitJson){ submitJson(payload, '/system/parameter/save', 'POST', '/system/parameter/list'); }
			else {
				try{
					const resp = await fetch('/system/parameter/save',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
					const res = await resp.json();
					if(res.code===200){ showMessage('保存成功','success'); window.location.href='/system/parameter/list'; }
					else showMessage('保存失败: '+res.message,'error');
				} catch(e){ showMessage('保存失败','error'); }
			}
		});
	})();
    </script>
    </th:block>
                    </div>
                </div>
            </main>
        </div>
    </div>
</body>
</html>