<!DOCTYPE html>
<html lang="zh-CN" 
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.w3.org/1999/xhtml"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/layout}">
<head>
    <title>编辑系统参数 - iJupiter Trading System</title>
    <th:block layout:fragment="css">
        <style>
            .form-label { font-weight: 600; }
            .required::after { content: "*"; color: #dc3545; margin-left: 4px; }
        </style>
    </th:block>
</head>
<body>
<div layout:fragment="content">
                    <div class="container-fluid">
		<div class="row">
			<div class="col-12">
				<div class="card">
					<div class="card-header">
						<h5 class="card-title mb-0">编辑参数</h5>
					</div>
					<div class="card-body">
						<form id="parameterForm">
							<input type="hidden" id="id" name="id" th:value="${parameter.id}"/>
							<div class="row">
								<div class="col-md-6">
									<div class="mb-3">
										<label for="paramCode" class="form-label required">参数编码</label>
										<input type="text" class="form-control" id="paramCode" name="paramCode" th:value="${parameter.paramCode}"/>
										<div class="invalid-feedback">请输入参数编码</div>
									</div>
									<div class="mb-3">
										<label for="paramName" class="form-label required">参数名称</label>
										<input type="text" class="form-control" id="paramName" name="paramName" th:value="${parameter.paramName}"/>
										<div class="invalid-feedback">请输入参数名称</div>
									</div>
									<div class="mb-3">
										<label for="paramType" class="form-label required">参数类型</label>
										<select class="form-select" id="paramType" name="paramType">
											<option value="STRING" th:selected="${parameter.paramType == 'STRING'}">字符串</option>
											<option value="NUMBER" th:selected="${parameter.paramType == 'NUMBER'}">数字</option>
											<option value="BOOLEAN" th:selected="${parameter.paramType == 'BOOLEAN'}">布尔</option>
											<option value="JSON" th:selected="${parameter.paramType == 'JSON'}">JSON</option>
										</select>
										<div class="invalid-feedback">请选择参数类型</div>
									</div>
									<div class="mb-3">
										<label for="paramGroup" class="form-label">参数分组</label>
										<input type="text" class="form-control" id="paramGroup" name="paramGroup" th:value="${parameter.paramGroup}"/>
									</div>
								</div>
								<div class="col-md-6">
									<div class="mb-3">
										<label for="paramValue" class="form-label required">参数值</label>
										<textarea class="form-control" id="paramValue" name="paramValue" rows="3" th:text="${parameter.paramValue}"></textarea>
										<div class="invalid-feedback">请输入参数值</div>
									</div>
									<div class="mb-3">
										<label for="defaultValue" class="form-label">默认值</label>
										<textarea class="form-control" id="defaultValue" name="defaultValue" rows="2" th:text="${parameter.defaultValue}"></textarea>
									</div>
									<div class="mb-3">
										<label for="validationRule" class="form-label">验证规则</label>
										<input type="text" class="form-control" id="validationRule" name="validationRule" th:value="${parameter.validationRule}"/>
									</div>
								</div>
							</div>

							<div class="mb-3">
								<label for="options" class="form-label">参数选项 (JSON)</label>
								<textarea class="form-control" id="options" name="options" rows="3" th:text="${parameter.options}"></textarea>
								<div class="form-text">用于下拉的选项，JSON数组，例如：[{"value":"1","label":"选项1"}]</div>
							</div>

							<div class="row">
								<div class="col-md-4">
									<div class="mb-3">
										<label for="isSystem" class="form-label">系统参数</label>
										<select class="form-select" id="isSystem" name="isSystem" disabled>
											<option value="0" th:selected="${parameter.isSystem == 0}">否</option>
											<option value="1" th:selected="${parameter.isSystem == 1}">是</option>
										</select>
									</div>
								</div>
								<div class="col-md-4">
									<div class="mb-3">
										<label for="isEditable" class="form-label">是否可编辑</label>
										<select class="form-select" id="isEditable" name="isEditable" th:disabled="${parameter.isSystem == 1}">
											<option value="1" th:selected="${parameter.isEditable == 1}">是</option>
											<option value="0" th:selected="${parameter.isEditable == 0}">否</option>
										</select>
									</div>
								</div>
								<div class="col-md-4">
									<div class="mb-3">
										<label for="sortOrder" class="form-label">排序号</label>
										<input type="number" class="form-control" id="sortOrder" name="sortOrder" th:value="${parameter.sortOrder ?: 0}"/>
									</div>
								</div>
							</div>

							<div class="mb-3">
								<label for="description" class="form-label">参数描述</label>
								<textarea class="form-control" id="description" name="description" rows="3" th:text="${parameter.description}"></textarea>
							</div>

							<div class="d-flex justify-content-end">
								<button type="button" class="btn btn-outline-secondary me-2" id="cancelBtn"><i class="fas fa-times me-1"></i>取消</button>
								<button type="button" class="btn btn-outline-primary me-2" id="validateBtn"><i class="fas fa-check me-1"></i>验证名称</button>
								<button type="submit" class="btn btn-primary" id="saveBtn" th:disabled="${parameter.isEditable == 0}"><i class="fas fa-save me-1"></i>保存</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>
</th:block>

<th:block layout:fragment="js">
	<script src="/js/system-ui.js"></script>
	<script src="/js/system-management.js"></script>
	<script>
		(function(){
			const idEl = document.getElementById('id');
			const id = idEl ? idEl.value : '';

			function showMessage(msg, type){ if(window.showToast){ window.showToast(type==='error'?'error':type, msg); } else alert(msg); }

			function validateForm(){
				let ok = true;
				['paramCode','paramName','paramType','paramValue'].forEach(function(fid){
					const el = document.getElementById(fid);
					if(!el) return;
					const v = (el.value || '').trim();
					if(!v){ el.classList.add('is-invalid'); ok = false; } else el.classList.remove('is-invalid');
				});
				return ok;
			}

			async function checkCode(code){
				if(!code) return true;
				try{
					const resp = await fetch(`/system/parameter/checkCode?paramCode=${encodeURIComponent(code)}&id=${encodeURIComponent(id)}`);
					const data = await resp.json();
					if(data && data.code === 200){ return true; }
					showMessage(data && data.message ? data.message : '编码校验失败', 'error');
					return false;
				} catch(e){ console.error(e); return false; }
			}

			document.getElementById('paramCode').addEventListener('blur', async function(){
				const code = this.value.trim();
				await checkCode(code);
			});

			async function validateParamName(){
				const name = (document.getElementById('paramName').value || '').trim();
				if(!name){ showMessage('请输入参数名称','error'); return false; }
				try{
					const resp = await fetch(`/system/parameter/check/paramname?paramName=${encodeURIComponent(name)}&id=${encodeURIComponent(id)}`);
					const res = await resp.json();
					if(res.code === 200){
						if(res.data){ showMessage('参数名称已存在，请使用其他名称','error'); document.getElementById('paramName').classList.add('is-invalid'); return false; }
						showMessage('参数名称可用','success'); document.getElementById('paramName').classList.remove('is-invalid'); return true;
					} else { showMessage('验证失败: '+res.message,'error'); return false; }
				} catch(e){ console.error(e); showMessage('验证失败','error'); return false; }
			}

			document.getElementById('validateBtn').addEventListener('click', function(){ validateParamName(); });

			document.getElementById('parameterForm').addEventListener('submit', async function(e){
				e.preventDefault();
				if(!validateForm()) return;
				const codeOk = await checkCode(document.getElementById('paramCode').value.trim());
				if(!codeOk) return;
				if(!document.getElementById('isEditable') || document.getElementById('isEditable').value === '0'){
					showMessage('此参数不可编辑','error'); return;
				}

				const payload = {
					id: id,
					paramCode: (document.getElementById('paramCode').value||'').trim(),
					paramName: (document.getElementById('paramName').value||'').trim(),
					paramValue: (document.getElementById('paramValue').value||'').trim(),
					paramType: (document.getElementById('paramType').value||'').trim(),
					paramGroup: (document.getElementById('paramGroup').value||'').trim(),
					defaultValue: (document.getElementById('defaultValue').value||'').trim(),
					validationRule: (document.getElementById('validationRule').value||'').trim(),
					options: (document.getElementById('options').value||'').trim(),
					description: (document.getElementById('description').value||'').trim(),
					isEditable: parseInt(document.getElementById('isEditable').value||'0'),
					sortOrder: parseInt(document.getElementById('sortOrder').value||'0')
				};

				const saveBtn = document.getElementById('saveBtn');
				saveBtn.disabled = true; const prevHtml = saveBtn.innerHTML; saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>保存中...';

				if(window.submitJson){
					const redirect = '/system/parameter/detail/' + id;
					submitJson(payload, '/system/parameter/update', 'PUT', redirect);
				} else {
					try{
						const resp = await fetch('/system/parameter/update', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
						const res = await resp.json();
						if(res.code === 200){ showMessage('更新成功','success'); window.location.href = '/system/parameter/detail/' + id; }
						else showMessage('更新失败: '+res.message,'error');
					} catch(e){ console.error(e); showMessage('更新失败','error'); }
					finally{ saveBtn.disabled = false; saveBtn.innerHTML = prevHtml; }
				}
			});

			document.getElementById('cancelBtn').addEventListener('click', function(){
				if(confirm('确定要取消吗？未保存的数据将丢失。')){ window.location.href = '/system/parameter/detail/' + id; }
			});

			// 如果不可编辑，禁用表单控件
			(function disableIfNeeded(){
				try{
					const isSys = document.getElementById('isSystem').value === '1';
					if(isSys){ Array.from(document.querySelectorAll('#parameterForm input, #parameterForm textarea, #parameterForm select')).forEach(el=>{ if(el.id!=='cancelBtn') el.disabled = true; }); }
				}catch(e){/* ignore */}
			})();
		})();
    </script>
    </th:block>
                    </div>
                </div>
            </main>
        </div>
    </div>
</body>
</html>
*** End Patch