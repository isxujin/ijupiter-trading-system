<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{common/base :: head}">
    <title>系统参数管理 - iJupiter Trading System</title>
    <th:block th:fragment="css">
        <style>
            .table-actions {
                white-space: nowrap;
            }
            .status-badge {
                padding: 0.25rem 0.5rem;
                border-radius: 0.25rem;
                font-size: 0.75rem;
            }
            .status-active {
                background-color: #d4edda;
                color: #155724;
            }
            .status-inactive {
                background-color: #f8d7da;
                color: #721c24;
            }
            .param-type-badge {
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
                border-radius: 0.25rem;
                background-color: #e2e3e5;
                color: #383d41;
            }
            .is-system-badge {
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
                border-radius: 0.25rem;
                background-color: #fff3cd;
                color: #856404;
            }
        </style>
    </th:block>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 主内容区 -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div th:fragment="content">
                    <div class="container-fluid">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">系统参数管理</h1>
        <div>
            <button type="button" class="btn btn-outline-primary" id="exportBtn">
                <i class="fas fa-download me-1"></i>导出配置
            </button>
            <button type="button" class="btn btn-outline-success" id="importBtn">
                <i class="fas fa-upload me-1"></i>导入配置
            </button>
            <a href="/system/parameter/add" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>新增参数
            </a>
        </div>
    </div>

    <!-- 搜索条件 -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="searchForm">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="keyword" class="form-label">关键词</label>
                        <input type="text" class="form-control" id="keyword" name="keyword" placeholder="参数编码/名称">
                    </div>
                    <div class="col-md-3">
                        <label for="paramGroup" class="form-label">参数分组</label>
                        <select class="form-select" id="paramGroup" name="paramGroup">
                            <option value="">全部分组</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="paramType" class="form-label">参数类型</label>
                        <select class="form-select" id="paramType" name="paramType">
                            <option value="">全部类型</option>
                            <option value="STRING">字符串</option>
                            <option value="NUMBER">数字</option>
                            <option value="BOOLEAN">布尔值</option>
                            <option value="JSON">JSON对象</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="status" class="form-label">状态</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">全部状态</option>
                            <option value="1">启用</option>
                            <option value="0">禁用</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <button type="button" class="btn btn-primary" id="searchBtn">
                            <i class="fas fa-search me-1"></i>搜索
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="resetBtn">
                            <i class="fas fa-redo me-1"></i>重置
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 数据表格 -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="parameterTable">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll"></th>
                            <th>参数编码</th>
                            <th>参数名称</th>
                            <th>参数值</th>
                            <th>参数类型</th>
                            <th>分组</th>
                            <th>状态</th>
                            <th>系统参数</th>
                            <th class="table-actions">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 数据将通过AJAX加载 -->
                    </tbody>
                </table>
            </div>
            
            <!-- 分页 -->
            <nav>
                <ul class="pagination justify-content-center" id="pagination">
                    <!-- 分页将通过JavaScript生成 -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- 批量操作模态框 -->
<div class="modal fade" id="batchModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">批量操作确认</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>确定要执行选中的批量操作吗？此操作不可恢复。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmBatchBtn">确认</button>
            </div>
        </div>
    </div>
</div>

<!-- 导入配置模态框 -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">导入参数配置</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="importForm">
                    <div class="mb-3">
                        <label for="configJson" class="form-label">配置JSON</label>
                        <textarea class="form-control" id="configJson" rows="10" placeholder="请粘贴导出的JSON配置..."></textarea>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="isOverride" name="isOverride">
                        <label class="form-check-label" for="isOverride">覆盖已存在的参数</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" id="confirmImportBtn">导入</button>
            </div>
        </div>
    </div>
</div>
</th:block>

<th:block th:fragment="js">
    <script src="/js/system-ui.js"></script>
    <script src="/js/system-management.js"></script>
    <script>
    (function(){
        let currentPage = 1;
        const pageSize = 10;

        function showMessage(message, type) {
            if (window.showToast) {
                window.showToast(type === 'error' ? 'error' : 'success', message);
            } else {
                alert(message);
            }
        }

        function truncateText(text, maxLength) {
            if (!text) return '-';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        async function loadParamGroups() {
            try {
                const res = await fetch('/system/parameter/groups');
                const data = await res.json();
                if (data.code === 200) {
                    const select = document.getElementById('paramGroup');
                    select.innerHTML = '<option value="">全部分组</option>' + (data.data || []).map(g => `<option value="${g}">${g}</option>`).join('');
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function loadParameters() {
            const keyword = document.getElementById('keyword').value;
            const paramGroup = document.getElementById('paramGroup').value;
            const paramType = document.getElementById('paramType').value;
            const status = document.getElementById('status').value;

            const params = new URLSearchParams({ pageNum: currentPage, pageSize });
            if (keyword) params.append('keyword', keyword);
            if (paramGroup) params.append('paramGroup', paramGroup);
            if (paramType) params.append('paramType', paramType);
            if (status) params.append('status', status);

            try {
                const resp = await fetch(`/system/parameter/data?${params.toString()}`);
                const res = await resp.json();
                if (res.code === 200) {
                    const records = res.data.records || [];
                    renderTable(records);
                    renderPagination(res.data);
                } else {
                    showMessage('加载数据失败: ' + res.message, 'error');
                }
            } catch (e) {
                console.error(e);
                showMessage('加载数据失败', 'error');
            }
        }

        function renderTable(parameters) {
            const tbody = document.querySelector('#parameterTable tbody');
            tbody.innerHTML = '';
            if (!parameters || parameters.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">暂无数据</td></tr>';
                return;
            }
            parameters.forEach(param => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" class="param-checkbox" data-id="${param.id}" ${param.isSystem === 1 ? 'disabled' : ''}></td>
                    <td>${param.paramCode}</td>
                    <td>${param.paramName}</td>
                    <td title="${param.paramValue}">${truncateText(param.paramValue,20)}</td>
                    <td><span class="param-type-badge">${param.paramType}</span></td>
                    <td>${param.paramGroup || '-'}</td>
                    <td>${param.status === 1 ? '<span class="status-badge status-active">启用</span>' : '<span class="status-badge status-inactive">禁用</span>'}</td>
                    <td>${param.isSystem === 1 ? '<span class="is-system-badge">系统</span>' : '业务'}</td>
                    <td class="table-actions"></td>
                `;
                const actionsTd = tr.querySelector('.table-actions');
                // details
                const aDetail = document.createElement('a');
                aDetail.href = `/system/parameter/detail/${param.id}`;
                aDetail.className = 'btn btn-sm btn-outline-info';
                aDetail.title = '详情';
                aDetail.innerHTML = '<i class="fas fa-eye"></i>';
                actionsTd.appendChild(aDetail);

                // edit
                const aEdit = document.createElement('a');
                aEdit.href = `/system/parameter/edit/${param.id}`;
                aEdit.className = 'btn btn-sm btn-outline-primary ms-1';
                aEdit.title = '编辑';
                if (param.isEditable === 0) aEdit.setAttribute('disabled','');
                aEdit.innerHTML = '<i class="fas fa-edit"></i>';
                actionsTd.appendChild(aEdit);

                // reset
                const btnReset = document.createElement('button');
                btnReset.className = 'btn btn-sm btn-outline-warning ms-1';
                btnReset.title = '重置';
                btnReset.innerHTML = '<i class="fas fa-undo"></i>';
                if (param.isEditable === 0 || !param.defaultValue) btnReset.disabled = true;
                btnReset.addEventListener('click', function(){
                    if (!confirm('确定要重置此参数为默认值吗？')) return;
                    fetch(`/system/parameter/reset/${param.id}`, { method: 'PUT' }).then(r=>r.json()).then(res=>{
                        if (res.code === 200) { showMessage('参数重置成功','success'); loadParameters(); }
                        else showMessage('参数重置失败: '+res.message,'error');
                    }).catch(()=>showMessage('参数重置失败','error'));
                });
                actionsTd.appendChild(btnReset);

                // status toggle
                const btnStatus = document.createElement('button');
                btnStatus.className = 'btn btn-sm ms-1';
                btnStatus.innerHTML = `<i class="fas fa-${param.status === 1 ? 'ban' : 'check'}"></i>`;
                if (param.status === 1) btnStatus.classList.add('btn-outline-secondary'); else btnStatus.classList.add('btn-outline-success');
                if (param.isSystem === 1 && param.status === 1) btnStatus.disabled = true;
                btnStatus.addEventListener('click', function(){
                    const newStatus = param.status === 1 ? 0 : 1;
                    fetch(`/system/parameter/status/${param.id}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({status:newStatus}) })
                        .then(r=>r.json()).then(res=>{ if(res.code===200){ showMessage('状态更新成功','success'); loadParameters(); } else showMessage('状态更新失败: '+res.message,'error'); }).catch(()=>showMessage('状态更新失败','error'));
                });
                actionsTd.appendChild(btnStatus);

                // delete
                const btnDelete = document.createElement('button');
                btnDelete.className = 'btn btn-sm btn-outline-danger ms-1';
                btnDelete.innerHTML = '<i class="fas fa-trash"></i>';
                if (param.isSystem === 1) btnDelete.disabled = true;
                btnDelete.addEventListener('click', function(){
                    if (!confirm('确定要删除此参数吗？此操作不可恢复。')) return;
                    fetch(`/system/parameter/delete/${param.id}`, { method: 'DELETE' }).then(r=>r.json()).then(res=>{ if(res.code===200){ showMessage('参数删除成功','success'); loadParameters(); } else showMessage('参数删除失败: '+res.message,'error'); }).catch(()=>showMessage('参数删除失败','error'));
                });
                actionsTd.appendChild(btnDelete);

                tbody.appendChild(tr);
            });
        }

        function renderPagination(pageData) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            if (!pageData || pageData.totalPages <= 1) return;
            const ulFrag = document.createDocumentFragment();
            const prevLi = document.createElement('li'); prevLi.className = 'page-item' + (pageData.pageNum===1?' disabled':'');
            prevLi.innerHTML = `<a class="page-link" href="#" data-page="${pageData.pageNum-1}">上一页</a>`;
            ulFrag.appendChild(prevLi);
            for (let i=1;i<=pageData.totalPages;i++){ const li=document.createElement('li'); li.className='page-item'+(i===pageData.pageNum?' active':''); li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`; ulFrag.appendChild(li);}            
            const nextLi = document.createElement('li'); nextLi.className='page-item'+(pageData.pageNum===pageData.totalPages?' disabled':''); nextLi.innerHTML=`<a class="page-link" href="#" data-page="${pageData.pageNum+1}">下一页</a>`; ulFrag.appendChild(nextLi);
            pagination.appendChild(ulFrag);
        }

        function getSelectedIds(){ return Array.from(document.querySelectorAll('.param-checkbox:checked')).map(cb=>cb.dataset.id); }

        function initEvents(){
            document.getElementById('searchBtn').addEventListener('click', function(){ currentPage=1; loadParameters(); });
            document.getElementById('resetBtn').addEventListener('click', function(){ document.getElementById('searchForm').reset(); currentPage=1; loadParameters(); });
            document.getElementById('selectAll').addEventListener('change', function(){ const checked=this.checked; document.querySelectorAll('.param-checkbox:not(:disabled)').forEach(cb=>cb.checked=checked); });
            document.getElementById('pagination').addEventListener('click', function(e){ const a=e.target.closest('a.page-link'); if(a){ e.preventDefault(); const page=a.dataset.page; if(page && parseInt(page)!==currentPage){ currentPage = parseInt(page); loadParameters(); } } });

            document.getElementById('exportBtn').addEventListener('click', async function(){ const paramGroup = document.getElementById('paramGroup').value; try{ const resp = await fetch(`/system/parameter/export?paramGroup=${encodeURIComponent(paramGroup)}`); const res = await resp.json(); if(res.code===200){ const dataStr = JSON.stringify(res.data,null,2); const dataUri = 'data:application/json;charset=utf-8,'+encodeURIComponent(dataStr); const link=document.createElement('a'); link.setAttribute('href',dataUri); link.setAttribute('download','parameters_'+Date.now()+'.json'); link.click(); showMessage('导出成功','success'); } else showMessage('导出失败: '+res.message,'error'); } catch(e){ showMessage('导出失败','error'); } });

            document.getElementById('importBtn').addEventListener('click', function(){ const modal = new bootstrap.Modal(document.getElementById('importModal')); modal.show(); });
            document.getElementById('confirmImportBtn').addEventListener('click', async function(){ const configJson = document.getElementById('configJson').value; const isOverride = document.getElementById('isOverride').checked; if(!configJson.trim()){ alert('请输入配置JSON'); return; } try{ JSON.parse(configJson); const resp = await fetch('/system/parameter/import',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({configJson, isOverride}) }); const res = await resp.json(); if(res.code===200){ showMessage(res.message,'success'); const modal = bootstrap.Modal.getInstance(document.getElementById('importModal')); if(modal) modal.hide(); loadParameters(); } else showMessage('导入失败: '+res.message,'error'); } catch(e){ alert('JSON格式不正确，请检查'); } });
        }

        // init
        loadParamGroups();
        loadParameters();
        initEvents();
    })();
    </script>
    </th:block>
                    </div>
                </div>
            </main>
        </div>
    </div>
</body>
</html>