<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{common/base :: layout(
      title = '用户管理',
      css = ~{::css},
      content = ~{::content},
      js = ~{::js}
    )}">
      
<th:block th:fragment="css">
    <style>
        .table-actions {
            white-space: nowrap;
        }
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
        }
        .status-active {
            background-color: #d4edda;
            color: #155724;
        }
        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</th:block>

<th:block th:fragment="content">
    <div class="container-fluid main-content">
        <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <h1 class="h3 mb-0 text-gray-800">用户管理</h1>
            <a href="/system/user/add" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm">
                <i class="bi bi-person-plus"></i> 添加用户
            </a>
        </div>

        <!-- 搜索栏 -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">搜索条件</h6>
            </div>
            <div class="card-body">
                <form id="searchForm">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="username">用户名</label>
                            <input type="text" class="form-control" id="username" name="username" placeholder="请输入用户名">
                        </div>
                        <div class="col-md-4">
                            <label for="email">邮箱</label>
                            <input type="email" class="form-control" id="email" name="email" placeholder="请输入邮箱">
                        </div>
                        <div class="col-md-4">
                            <label for="status">状态</label>
                            <select class="form-select" id="status" name="status">
                                <option value="">全部</option>
                                <option value="active">激活</option>
                                <option value="inactive">禁用</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button type="button" class="btn btn-primary" onclick="search()">
                                <i class="bi bi-search"></i> 搜索
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetSearch()">
                                <i class="bi bi-arrow-clockwise"></i> 重置
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 数据表格 -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">用户列表</h6>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="batchDelete()">
                        <i class="bi bi-trash"></i> 批量删除
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="userTable">
                        <thead>
                            <tr>
                                <th width="40">
                                    <input type="checkbox" class="form-check-input" id="selectAll">
                                </th>
                                <th>ID</th>
                                <th>用户名</th>
                                <th>真实姓名</th>
                                <th>邮箱</th>
                                <th>手机号</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>最后登录时间</th>
                                <th width="150">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
                <nav aria-label="Page navigation" class="mt-3">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- 分页将通过JavaScript动态生成 -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- 确认删除模态框 -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">确认删除</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    确定要删除选中的用户吗？此操作不可撤销。
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">确认删除</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 状态切换模态框 -->
    <div class="modal fade" id="statusModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">更改用户状态</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="userStatus" class="form-label">选择状态</label>
                        <select class="form-select" id="userStatus">
                            <option value="active">激活</option>
                            <option value="inactive">禁用</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmStatusChange">确认更改</button>
                </div>
            </div>
        </div>
    </div>
</th:block>

<th:block th:fragment="js">
    <script>
        let currentPage = 1;
        let pageSize = 10;
        let deleteUserId = null;

        document.addEventListener('DOMContentLoaded', function() {
            // 初始化数据加载
            loadData();
            
            // 全选/取消全选
            document.getElementById('selectAll').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('tbody input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
            });
        });

        // 搜索
        function search() {
            currentPage = 1;
            loadData();
        }

        // 重置搜索
        function resetSearch() {
            document.getElementById('searchForm').reset();
            currentPage = 1;
            loadData();
        }

        // 加载数据
        function loadData() {
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const status = document.getElementById('status').value;
            
            const params = new URLSearchParams({
                pageNum: currentPage,
                pageSize: pageSize
            });
            
            if (username) params.append('username', username);
            if (email) params.append('email', email);
            if (status) params.append('status', status);
            
            fetch(`/system/user/data?${params}`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 0) {
                        renderTable(data.data);
                        renderPagination(data);
                    } else {
                        showError('加载数据失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError('加载数据失败，请检查网络连接');
                });
        }

        // 渲染表格
        function renderTable(data) {
            const tbody = document.querySelector('#userTable tbody');
            tbody.innerHTML = '';
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center">暂无数据</td></tr>';
                return;
            }
            
            data.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <input type="checkbox" class="form-check-input user-checkbox" value="${user.id}">
                    </td>
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.realName || ''}</td>
                    <td>${user.email}</td>
                    <td>${user.phoneNumber || ''}</td>
                    <td>
                        <span class="status-badge ${user.status === 'active' ? 'status-active' : 'status-inactive'}">
                            ${user.status === 'active' ? '激活' : '禁用'}
                        </span>
                    </td>
                    <td>${formatDateTime(user.createdAt)}</td>
                    <td>${formatDateTime(user.lastLoginTime)}</td>
                    <td class="table-actions">
                        <a href="/system/user/edit/${user.id}" class="btn btn-sm btn-primary">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <button class="btn btn-sm ${user.status === 'active' ? 'btn-warning' : 'btn-success'}" 
                                onclick="changeStatus(${user.id}, '${user.status}')">
                            <i class="bi ${user.status === 'active' ? 'bi-pause' : 'bi-play'}"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 渲染分页
        function renderPagination(data) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            const { pageNum, pages, total, hasNext, hasPrevious } = data;
            
            // 上一页
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${!hasPrevious ? 'disabled' : ''}`;
            prevLi.innerHTML = `
                <a class="page-link" href="#" onclick="${hasPrevious ? `goToPage(${pageNum - 1})` : 'return false'}">
                    上一页
                </a>
            `;
            pagination.appendChild(prevLi);
            
            // 页码
            for (let i = 1; i <= pages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === pageNum ? 'active' : ''}`;
                li.innerHTML = `
                    <a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>
                `;
                pagination.appendChild(li);
            }
            
            // 下一页
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${!hasNext ? 'disabled' : ''}`;
            nextLi.innerHTML = `
                <a class="page-link" href="#" onclick="${hasNext ? `goToPage(${pageNum + 1})` : 'return false'}">
                    下一页
                </a>
            `;
            pagination.appendChild(nextLi);
            
            // 显示信息
            const infoLi = document.createElement('li');
            infoLi.className = 'page-item disabled ms-3';
            infoLi.innerHTML = `
                <a class="page-link" href="#" tabindex="-1">
                    共 ${total} 条记录，第 ${pageNum}/${pages} 页
                </a>
            `;
            pagination.appendChild(infoLi);
        }

        // 跳转页面
        function goToPage(page) {
            currentPage = page;
            loadData();
        }

        // 删除用户
        function deleteUser(id) {
            deleteUserId = id;
            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();
        }

        // 批量删除
        function batchDelete() {
            const checkboxes = document.querySelectorAll('.user-checkbox:checked');
            if (checkboxes.length === 0) {
                showWarning('请选择要删除的用户');
                return;
            }
            
            if (confirm(`确定要删除选中的 ${checkboxes.length} 个用户吗？此操作不可撤销。`)) {
                const ids = Array.from(checkboxes).map(cb => cb.value);
                
                fetch('/system/user/batch', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(ids)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        showSuccess('批量删除成功');
                        loadData();
                    } else {
                        showError('批量删除失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError('批量删除失败，请检查网络连接');
                });
            }
        }

        // 确认删除
        document.getElementById('confirmDelete').addEventListener('click', function() {
            if (!deleteUserId) return;
            
            fetch(`/system/user/delete/${deleteUserId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                modal.hide();
                
                if (data.code === 200) {
                    showSuccess('删除成功');
                    loadData();
                } else {
                    showError('删除失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('删除失败，请检查网络连接');
            });
        });

        // 更改用户状态
        function changeStatus(id, currentStatus) {
            deleteUserId = id;
            const modal = new bootstrap.Modal(document.getElementById('statusModal'));
            const statusSelect = document.getElementById('userStatus');
            
            // 设置当前状态
            statusSelect.value = currentStatus === 'active' ? 'active' : 'inactive';
            
            modal.show();
        }

        // 确认状态更改
        document.getElementById('confirmStatusChange').addEventListener('click', function() {
            if (!deleteUserId) return;
            
            const newStatus = document.getElementById('userStatus').value;
            
            fetch(`/system/user/status/${deleteUserId}?status=${newStatus}`, {
                method: 'PUT'
            })
            .then(response => response.json())
            .then(data => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('statusModal'));
                modal.hide();
                
                if (data.code === 200) {
                    showSuccess('状态更新成功');
                    loadData();
                } else {
                    showError('状态更新失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('状态更新失败，请检查网络连接');
            });
        });

        // 格式化日期时间
        function formatDateTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        // 显示成功消息
        function showSuccess(message) {
            // 这里可以使用Toast或其他方式显示成功消息
            console.log(message);
        }

        // 显示错误消息
        function showError(message) {
            // 这里可以使用Toast或其他方式显示错误消息
            console.error(message);
        }

        // 显示警告消息
        function showWarning(message) {
            // 这里可以使用Toast或其他方式显示警告消息
            console.warn(message);
        }
    </script>
</th:block>
</html>