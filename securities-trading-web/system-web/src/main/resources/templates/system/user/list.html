<!DOCTYPE html>
<html lang="zh-CN"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/layout}">

<th:block th:fragment="css">
    <style>
        .table-actions {
            white-space: nowrap;
        }
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
        }
        .status-active {
            background-color: #d4edda;
            color: #155724;
        }
        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
        .table-responsive {
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        }
        .pagination-info {
            margin-left: 1rem;
        }
    </style>
</th:block>

<body>
<div layout:fragment="content">
    <div class="container-fluid">
                <div class="d-sm-flex align-items-center justify-content-between mb-4">
                    <h1 class="h3 mb-0 text-gray-800">用户管理</h1>
                    <a href="/system/user/add" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm">
                        <i class="bi bi-person-plus"></i> 添加用户
                    </a>
                </div>

                <!-- 搜索栏 -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">搜索条件</h6>
                    </div>
                    <div class="card-body">
                        <form id="searchForm">
                            <div class="row">
                                <div class="col-md-3">
                                    <label for="username">用户名</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-person"></i></span>
                                        <input type="text" class="form-control" id="username" name="username" placeholder="请输入用户名">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label for="email">邮箱</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                                        <input type="email" class="form-control" id="email" name="email" placeholder="请输入邮箱">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label for="status">状态</label>
                                    <select class="form-select" id="status" name="status">
                                        <option value="">全部状态</option>
                                        <option value="active">激活</option>
                                        <option value="inactive">禁用</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="role">角色</label>
                                    <select class="form-select" id="role" name="role">
                                        <option value="">全部角色</option>
                                        <option value="admin">管理员</option>
                                        <option value="trader">交易员</option>
                                        <option value="user">普通用户</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label for="createdTimeRange">创建时间范围</label>
                                    <div class="input-group">
                                        <input type="date" class="form-control" id="startDate" name="startDate">
                                        <span class="input-group-text">至</span>
                                        <input type="date" class="form-control" id="endDate" name="endDate">
                                    </div>
                                </div>
                                <div class="col-md-6 d-flex align-items-end">
                                    <button type="button" class="btn btn-primary me-2" onclick="search()">
                                        <i class="bi bi-search"></i> 搜索
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary me-2" onclick="resetSearch()">
                                        <i class="bi bi-arrow-clockwise"></i> 重置
                                    </button>
                                    <button type="button" class="btn btn-outline-success" onclick="exportData()">
                                        <i class="bi bi-download"></i> 导出
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 数据表格 -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">用户列表</h6>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="batchDelete()">
                                <i class="bi bi-trash"></i> 批量删除
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="userTable">
                                <thead>
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" class="form-check-input" id="selectAll">
                                    </th>
                                    <th>用户</th>
                                    <th>真实姓名</th>
                                    <th>邮箱</th>
                                    <th>手机号</th>
                                    <th>状态</th>
                                    <th>角色</th>
                                    <th>创建时间</th>
                                    <th>最后登录时间</th>
                                    <th width="150">操作</th>
                                </tr>
                                </thead>
                                <tbody>
                                <!-- 数据将通过JavaScript动态加载 -->
                                </tbody>
                            </table>
                        </div>
                        <nav aria-label="Page navigation" class="mt-3">
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- 分页将通过JavaScript动态生成 -->
                            </ul>
                        </nav>
                    </div>
                </div>

                <!-- 确认删除模态框 -->
                <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">确认删除</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                确定要删除选中的用户吗？此操作不可撤销。
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-danger" id="confirmDelete">确认删除</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 状态切换模态框 -->
                <div class="modal fade" id="statusModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">更改用户状态</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-warning" id="statusAlert" style="display: none;">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    <span id="statusAlertMessage"></span>
                                </div>
                                <div class="mb-3">
                                    <label for="userStatus" class="form-label">选择状态</label>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" name="statusOption" id="statusActive" value="active" checked>
                                        <label class="form-check-label" for="statusActive">
                                            <span class="badge bg-success">激活</span> 用户可以正常登录和使用系统
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" name="statusOption" id="statusInactive" value="inactive">
                                        <label class="form-check-label" for="statusInactive">
                                            <span class="badge bg-danger">禁用</span> 用户无法登录系统
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" name="statusOption" id="statusLocked" value="locked">
                                        <label class="form-check-label" for="statusLocked">
                                            <span class="badge bg-warning text-dark">锁定</span> 用户账号被锁定，需要管理员解锁
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="statusReason" class="form-label">原因说明（可选）</label>
                                    <textarea class="form-control" id="statusReason" rows="2" placeholder="请说明更改状态的原因"></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" id="confirmStatusChange">确认更改</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script th:src="@{/webjars/jquery/{version}/dist/jquery.min.js(version=${webjarsVersion.jquery})}"></script>
    <script th:src="@{/webjars/bootstrap/{version}/js/bootstrap.bundle.min.js(version=${webjarsVersion.bootstrap})}"></script>
    
    <th:block th:fragment="js">
        <script src="/js/system-ui.js"></script>
        <script src="/js/system-management.js"></script>
        <script>
        let currentPage = 1;
        let pageSize = 10;
        let deleteUserId = null;

        document.addEventListener('DOMContentLoaded', function() {
            // 初始化数据加载
            loadData();
            
            // 全选/取消全选
            document.getElementById('selectAll').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('tbody input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
            });
        });

        // 搜索
        function search() {
            currentPage = 1;
            loadData();
        }

        // 重置搜索
        function resetSearch() {
            document.getElementById('searchForm').reset();
            currentPage = 1;
            loadData();
        }

        // 加载数据
        function loadData() {
            // 显示加载中状态
            const tbody = document.querySelector('#userTable tbody');
            tbody.innerHTML = '<tr><td colspan="10" class="text-center py-4"><div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">加载中...</span></div> 正在加载数据...</td></tr>';
            
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const status = document.getElementById('status').value;
            const role = document.getElementById('role').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const params = new URLSearchParams({
                pageNum: currentPage,
                pageSize: pageSize
            });
            
            if (username) params.append('username', username);
            if (email) params.append('email', email);
            if (status) params.append('status', status);
            if (role) params.append('role', role);
            if (startDate) params.append('startDate', startDate);
            if (endDate) params.append('endDate', endDate);
            
            fetch(`/system/user/data?${params}`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 0) {
                        renderTable(data.data.list || data.data);
                        renderPagination(data.data);
                    } else {
                        showError('加载数据失败: ' + data.message);
                        tbody.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-danger">加载数据失败</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError('加载数据失败，请检查网络连接');
                    tbody.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-danger">加载数据失败，请检查网络连接</td></tr>';
                });
        }

        // 导出数据
        function exportData() {
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const status = document.getElementById('status').value;
            const role = document.getElementById('role').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const params = new URLSearchParams();
            
            if (username) params.append('username', username);
            if (email) params.append('email', email);
            if (status) params.append('status', status);
            if (role) params.append('role', role);
            if (startDate) params.append('startDate', startDate);
            if (endDate) params.append('endDate', endDate);
            
            window.location.href = `/system/user/export?${params.toString()}`;
            showSuccess('导出请求已发送，请稍后下载');
        }

        // 渲染表格
        function renderTable(data) {
            const tbody = document.querySelector('#userTable tbody');
            tbody.innerHTML = '';
            
            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center py-5">
                            <div class="d-flex flex-column align-items-center">
                                <i class="bi bi-people fs-1 text-muted mb-3"></i>
                                <h5 class="text-muted">暂无用户数据</h5>
                                <p class="text-muted">请尝试调整搜索条件或添加新用户</p>
                                <a href="/system/user/add" class="btn btn-primary mt-2">
                                    <i class="bi bi-person-plus"></i> 添加用户
                                </a>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            data.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <input type="checkbox" class="form-check-input user-checkbox" value="${user.id}">
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar-sm me-2">
                                <img src="https://ui-avatars.com/api/?name=${user.username}&background=random&color=fff" 
                                     alt="${user.username}" class="user-avatar">
                            </div>
                            <div>
                                <div class="fw-medium">${user.username}</div>
                                <small class="text-muted">ID: ${user.id}</small>
                            </div>
                        </div>
                    </td>
                    <td>${user.realName || '-'}</td>
                    <td>${user.email || '-'}</td>
                    <td>${user.phoneNumber || '-'}</td>
                    <td>
                        <span class="status-badge ${user.status === 'active' ? 'status-active' : 'status-inactive'}">
                            ${user.status === 'active' ? '激活' : '禁用'}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-info text-dark">${user.role || '普通用户'}</span>
                    </td>
                    <td>${formatDateTime(user.createdAt)}</td>
                    <td>${formatDateTime(user.lastLoginTime)}</td>
                    <td class="table-actions">
                        <div class="btn-group" role="group">
                            <a href="/system/user/edit/${user.id}" class="btn btn-sm btn-primary" title="编辑">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <a href="/system/user/detail/${user.id}" class="btn btn-sm btn-info" title="详情">
                                <i class="bi bi-eye"></i>
                            </a>
                            <button class="btn btn-sm ${user.status === 'active' ? 'btn-warning' : 'btn-success'}" 
                                    onclick="changeStatus(${user.id}, '${user.status}')" 
                                    title="${user.status === 'active' ? '禁用' : '激活'}">
                                <i class="bi ${user.status === 'active' ? 'bi-pause' : 'bi-play'}"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})" title="删除">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 渲染分页
        function renderPagination(data) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            if (!data) return;
            
            const { pageNum = 1, pages = 0, total = 0, hasNext = false, hasPrevious = false } = data;
            
            // 分页信息
            const infoDiv = document.createElement('div');
            infoDiv.className = 'd-flex justify-content-between align-items-center w-100 mb-2';
            infoDiv.innerHTML = `
                <div class="text-muted">显示 ${((pageNum - 1) * pageSize) + 1} - ${Math.min(pageNum * pageSize, total)} 条，共 ${total} 条记录</div>
                <div class="d-flex align-items-center">
                    <div class="input-group input-group-sm me-3" style="width: 120px;">
                        <select class="form-select" id="pageSizeSelect" onchange="changePageSize(this.value)">
                            <option value="10" ${pageSize === 10 ? 'selected' : ''}>10 条/页</option>
                            <option value="20" ${pageSize === 20 ? 'selected' : ''}>20 条/页</option>
                            <option value="50" ${pageSize === 50 ? 'selected' : ''}>50 条/页</option>
                            <option value="100" ${pageSize === 100 ? 'selected' : ''}>100 条/页</option>
                        </select>
                    </div>
                    <div class="input-group input-group-sm" style="width: 150px;">
                        <span class="input-group-text">跳转</span>
                        <input type="number" class="form-control" id="pageJumpInput" min="1" max="${pages}" value="${pageNum}">
                        <button class="btn btn-outline-secondary" type="button" onclick="jumpToPage()">Go</button>
                    </div>
                </div>
            `;
            pagination.parentNode.insertBefore(infoDiv, pagination);
            
            if (pages <= 1) return;
            
            // 上一页
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${!hasPrevious ? 'disabled' : ''}`;
            prevLi.innerHTML = `
                <a class="page-link" href="#" ${hasPrevious ? `onclick="goToPage(${pageNum - 1})"` : ''}>
                    <i class="bi bi-chevron-left"></i>
                </a>
            `;
            pagination.appendChild(prevLi);
            
            // 页码 - 优化显示逻辑，最多显示7个页码
            let startPage = Math.max(1, pageNum - 3);
            let endPage = Math.min(pages, startPage + 6);
            
            if (endPage - startPage < 6) {
                startPage = Math.max(1, endPage - 6);
            }
            
            // 第一页
            if (startPage > 1) {
                const firstLi = document.createElement('li');
                firstLi.className = 'page-item';
                firstLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(1)">1</a>`;
                pagination.appendChild(firstLi);
                
                if (startPage > 2) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = `<a class="page-link" href="#">...</a>`;
                    pagination.appendChild(ellipsisLi);
                }
            }
            
            // 页码范围
            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === pageNum ? 'active' : ''}`;
                li.innerHTML = `
                    <a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>
                `;
                pagination.appendChild(li);
            }
            
            // 最后一页
            if (endPage < pages) {
                if (endPage < pages - 1) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = `<a class="page-link" href="#">...</a>`;
                    pagination.appendChild(ellipsisLi);
                }
                
                const lastLi = document.createElement('li');
                lastLi.className = 'page-item';
                lastLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${pages})">${pages}</a>`;
                pagination.appendChild(lastLi);
            }
            
            // 下一页
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${!hasNext ? 'disabled' : ''}`;
            nextLi.innerHTML = `
                <a class="page-link" href="#" ${hasNext ? `onclick="goToPage(${pageNum + 1})"` : ''}>
                    <i class="bi bi-chevron-right"></i>
                </a>
            `;
            pagination.appendChild(nextLi);
        }

        // 跳转页面
        function goToPage(page) {
            currentPage = page;
            loadData();
        }

        // 修改每页显示数量
        function changePageSize(newPageSize) {
            pageSize = parseInt(newPageSize);
            currentPage = 1;
            loadData();
        }

        // 跳转到指定页
        function jumpToPage() {
            const input = document.getElementById('pageJumpInput');
            const page = parseInt(input.value);
            
            if (isNaN(page) || page < 1) {
                showWarning('请输入有效的页码');
                return;
            }
            
            goToPage(page);
        }

        // 删除用户
        function deleteUser(id) {
            deleteUserId = id;
            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();
        }

        // 批量删除
        function batchDelete() {
            const checkboxes = document.querySelectorAll('.user-checkbox:checked');
            if (checkboxes.length === 0) {
                showWarning('请选择要删除的用户');
                return;
            }
            
            if (confirm(`确定要删除选中的 ${checkboxes.length} 个用户吗？此操作不可撤销。`)) {
                const ids = Array.from(checkboxes).map(cb => cb.value);
                
                fetch('/system/user/batch', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(ids)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        showSuccess('批量删除成功');
                        loadData();
                    } else {
                        showError('批量删除失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError('批量删除失败，请检查网络连接');
                });
            }
        }

        // 确认删除
        document.getElementById('confirmDelete').addEventListener('click', function() {
            if (!deleteUserId) return;
            
            fetch(`/system/user/delete/${deleteUserId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                modal.hide();
                
                if (data.code === 200) {
                    showSuccess('删除成功');
                    loadData();
                } else {
                    showError('删除失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('删除失败，请检查网络连接');
            });
        });

        // 更改用户状态
        function changeStatus(id, currentStatus) {
            deleteUserId = id;
            const modal = new bootstrap.Modal(document.getElementById('statusModal'));
            const statusAlert = document.getElementById('statusAlert');
            const statusAlertMessage = document.getElementById('statusAlertMessage');
            
            // 设置当前状态
            const statusOption = document.querySelector(`input[name="statusOption"][value="${currentStatus}"]`);
            if (statusOption) {
                statusOption.checked = true;
            }
            
            // 清空原因说明
            document.getElementById('statusReason').value = '';
            
            // 隐藏警告信息
            statusAlert.style.display = 'none';
            
            modal.show();
        }

        // 确认状态更改
        document.getElementById('confirmStatusChange').addEventListener('click', function() {
            if (!deleteUserId) return;
            
            const newStatus = document.querySelector('input[name="statusOption"]:checked')?.value;
            const reason = document.getElementById('statusReason').value;
            const statusAlert = document.getElementById('statusAlert');
            const statusAlertMessage = document.getElementById('statusAlertMessage');
            
            if (!newStatus) {
                showError('请选择一个状态');
                return;
            }
            
            // 如果设置为禁用或锁定，显示警告
            if (newStatus === 'inactive' || newStatus === 'locked') {
                statusAlert.style.display = 'block';
                statusAlertMessage.textContent = `您即将${newStatus === 'inactive' ? '禁用' : '锁定'}该用户，用户将无法登录系统。请确认操作。`;
            }
            
            fetch(`/system/user/status/${deleteUserId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    status: newStatus,
                    reason: reason
                })
            })
            .then(response => response.json())
            .then(data => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('statusModal'));
                modal.hide();
                
                if (data.code === 200) {
                    showSuccess('状态更新成功');
                    loadData();
                } else {
                    showError('状态更新失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('状态更新失败，请检查网络连接');
            });
        });

        // 格式化日期时间
        function formatDateTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        // 显示成功/错误/警告消息，使用统一 Toast（如不可用则回退到 console）
        function showSuccess(message) {
            if (window.showToast) window.showToast('success', message); else console.log(message);
        }

        function showError(message) {
            if (window.showToast) window.showToast('error', message); else console.error(message);
        }

        function showWarning(message) {
            if (window.showToast) window.showToast('info', message); else console.warn(message);
        }
    </script>
    </th:block>
</body>
</html>