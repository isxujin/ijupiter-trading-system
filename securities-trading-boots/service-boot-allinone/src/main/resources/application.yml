# ========== 1. Spring 容器配置 ==========
spring:
  # 1.1 应用配置
  application:
    name: service-boot-menagement
  # 1.2 数据源配置
  datasource:
    url: jdbc:mysql://localhost:3306/ijupiter_schema?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: root              # 数据库账号
    password: xujin@110418      # 数据库密码
    driver-class-name: com.mysql.cj.jdbc.Driver
    # 连接池配置（生产环境必配）
    hikari:
      maximum-pool-size: 10  # 最大连接数
      minimum-idle: 5        # 最小空闲连接
      idle-timeout: 300000   # 连接空闲超时
      connection-timeout: 20000 # 连接超时
  # 1.3 JPA/Hibernate 配置
  jpa:
    # 数据库方言（MySQL 8.x 用这个，PostgreSQL 替换为 org.hibernate.dialect.PostgreSQLDialect）
    database-platform: org.hibernate.dialect.MySQL8Dialect
    # 显式指定实体扫描（兜底，与启动类 @EntityScan 配合）
    packages-to-scan:
      - net.ijupiter.trading.core
      - org.axonframework.eventhandling.tokenstore.jpa
      - org.axonframework.eventsourcing.eventstore.jpa
    hibernate:
      ddl-auto: update  # 开发环境：update（自动创建/更新表）；生产环境：none（手动建表，避免误删）
    show-sql: true     # 显示 SQL（开发环境开启，生产关闭）
    properties:
      hibernate:
        #id:
        #  db_structure_naming_strategy: IDENTITY #sequence  #legacy-hilo
        format_sql: true                  # 格式化 SQL 日志
        use_sql_comments: true            # 显示 SQL 注释
        globally_quoted_identifiers: false # 关闭全局引用标识符，避免生成带双引号的标识符
        physical_naming_strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl # 使用标准物理命名策略
    open-in-view: false
  # 1.4 消息队列配置
  rabbitmq:
    host: localhost           # RabbitMQ 服务地址（生产环境替换为集群地址）
    port: 5672                # 默认端口
    username: guest           # 认证账号（生产环境建议自定义）
    password: guest           # 认证密码
    virtual-host: /           # 虚拟主机（默认）
    connection-timeout: 30000 # 连接超时
  # 1.5 Spring-data 配置
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: 0

# ========== 2. Axon 事件引擎配置 ==========
axon:
  # 可选：指定上下文（默认default）
  context: default
  # 2.0 事件处理器配置（可选，默认即可）
  eventhandling:
    processors:
      net.ijupiter.trading.core.query.handler:
        mode: tracking
        tracking:
          batch-size: 50 # 批量消费事件（默认10，可根据事件量调整）
          token-claim-interval: 5000ms # Token 认领间隔
          token-timeout: 30000ms # Token 超时时间（避免分段被锁死）
          thread-count: 2 # 多线程消费（事件量较大时增加）
          initial-token: latest # 首次启动从最新事件开始消费（可选：earliest 从起始位置）
  # 2.1 序列化配置（Command 序列化/反序列化，建议用 Jackson）
  serializer:
    ggeneral: jackson       # 通用序列化（Command/Event 均用 Jackson）
    messages: jackson       # 消息序列化
    events: jackson         # 事件专用序列化器（必须配置，保证事件序列化一致性）
  # 2.1.1 可选：Jackson 序列化自定义配置
  jackson:
    serialization:
      indent-output: false
      fail-on-empty-beans: false
  # 2.2 事件存储配置（可选，默认即可）
  eventstore:
    # 快照触发策略（可选：聚合根事件数达到 50 触发快照）
    snapshot-threshold: 50
  # 2.3 AMQP 连接器配置（适配 RabbitMQ）
  amqp:
    exchange: axon-command-exchange  # 命令传输的交换机名称（自动创建）
    queue: axon-command-queue        # 命令队列名称（自动创建）
    routing-key: axon.command        # 路由键（匹配交换机与队列）
    auto-delete: false               # 队列是否自动删除（生产环境设为 false）
    durable: true                    # 交换机/队列是否持久化（生产环境必开）
    declare-exchange: true           # 自动声明交换机
    declare-queue: true              # 自动声明队列
    binding-routing-key: axon.command # 交换机与队列的绑定键

# 中间件配置
middleware:
  rabbitmq:
    host: ${RABBITMQ_HOST:localhost}
    port: ${RABBITMQ_PORT:5672}
    username: ${RABBITMQ_USER:guest}
    password: ${RABBITMQ_PWD:guest}
    virtual-host: /

# 查询模块特定配置
trading:
  query:
    event-processor:
      thread-pool-size: 4
      batch-size: 100
    cache:
      enabled: true
      ttl: 300
      max-size: 10000
    pagination:
      default-page: 1
      default-size: 20
      max-size: 100

# 日志配置
logging:
  level:
    net.ijupiter.trading: DEBUG
    org.springframework: INFO
    org.hibernate: INFO
    org.axonframework: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

# 管理端点
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always